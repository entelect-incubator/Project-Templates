# Generated API Client Integration Guide

## Overview

The project uses **NSwag** to generate a type-safe React API client from the backend OpenAPI specification. This document outlines the generated client structure and integration plan.

## Generated Client Location

```
clients/generated/react/src/api/generated.ts
```

**Generated by:** NSwag 14.6.2.0  
**Namespace:** `PizzaApi`  
**Main Class:** `PizzaApiClient`

## Current Implementation Status

### ‚úÖ Generated Client Exists
The NSwag-generated `PizzaApiClient` is fully available with all methods and types properly generated.

### ‚ö†Ô∏è Currently NOT Used
Our current implementation uses manual `fetch()` calls instead of the generated client. This means:
- ‚ùå Missing type-safe API contracts
- ‚ùå Code duplication between manual implementation and generated types
- ‚úÖ But: Manual implementation is working correctly with proper error handling

### üìç Migration Path
The hooks in `src/api/hooks.ts` are intentionally structured to mirror the generated client API contracts. This allows for easy migration when module resolution is configured.

## Generated Client API Methods

### Pizza Operations

#### `search_for_pizzas(query: GetAllPizzasQuery): Promise<ResultOfIEnumerableOfPizzaModel>`

**Current Manual Implementation:**
```typescript
// src/api/hooks.ts - fetchPizzas()
const response = await fetch(API_ENDPOINTS.pizzas);
const data = await response.json();
return data as Pizza[];
```

**Generated Client Implementation:**
```typescript
const client = new PizzaApi.PizzaApiClient(baseUrl, fetch);
const query = new GetAllPizzasQuery();
const result = await client.search_for_pizzas(query);
const pizzas = result.result; // Extract from Result wrapper
```

#### `create_a_pizza(command: CreatePizzaCommand): Promise<ResultOfPizzaModel>`
- Creates a new pizza
- Returns: Wrapped pizza model with validation result

#### `update_pizza(command: UpdatePizzaCommand): Promise<ResultOfPizzaModel>`
- Updates existing pizza
- Returns: Wrapped pizza model

### Order Operations

#### `create_order(command: CreateOrderCommand): Promise<ResultOfOrderModel>`

**Current Manual Implementation:**
```typescript
// src/api/hooks.ts - useCreateOrder()
const response = await fetch(API_ENDPOINTS.orders, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(command),
});
return response.json() as Promise<Order>;
```

**Generated Client Implementation:**
```typescript
const client = new PizzaApi.PizzaApiClient(baseUrl, fetch);
const result = await client.create_order(command);
const order = result.result; // Extract from Result wrapper
```

#### `complete_order(command: CompleteOrderCommand): Promise<ResultOfOrderModel>`
- Marks an order as complete
- Returns: Wrapped order model

#### `get_order_status(id: number): Promise<ResultOfOrderStatus>`

**Current Manual Implementation:**
```typescript
// src/features/pizzas/hooks/useOrderTracking.ts
const response = await fetch(`${API_ENDPOINTS.orders}/${id}`);
return response.json() as Promise<OrderStatus>;
```

**Generated Client Implementation:**
```typescript
const client = new PizzaApi.PizzaApiClient(baseUrl, fetch);
const result = await client.get_order_status(id);
const status = result.result; // Extract from Result wrapper
```

### Health Check

#### `getHc(): Promise<void>`
- Health check endpoint

## Generated Type Definitions

The generated client includes all necessary types:

- `GetAllPizzasQuery` - Search parameters for pizzas
- `CreatePizzaCommand` - Command to create a pizza
- `UpdatePizzaCommand` - Command to update a pizza
- `CreateOrderCommand` - Command to create an order
- `CompleteOrderCommand` - Command to complete an order
- `PizzaModel` - Pizza data model
- `OrderModel` - Order data model
- `OrderStatus` - Order status information
- `ResultOfT` - Generic result wrapper for all responses
- `ValidationErrorResult` - Validation error details
- `ErrorResult` - Error details

## Current Architecture

The hooks layer (`src/api/hooks.ts`) provides:
- ‚úÖ React Query integration with `useSuspenseQuery`, `useQuery`, `useMutation`
- ‚úÖ Telemetry integration with span tracking
- ‚úÖ Error handling and telemetry events
- ‚úÖ Network awareness (checks `navigator.onLine`)
- ‚úÖ Proper TypeScript types for all operations

## Integration Plan

### Phase 1: Module Resolution Setup (Blocker)
**Status:** ‚è≥ Pending

**Issue:** Module resolution for `clients/generated/react/src/api/generated.ts`

**Solution Options:**
1. **Create NPM package** (Recommended)
   - Add `package.json` to `clients/generated/react/`
   - Build as publishable package
   - Add to workspace dependencies

2. **Configure path aliases** (Current approach)
   - ‚úÖ Already added `@generated` alias to `vite.config.ts` and `tsconfig.json`
   - Need Vite/TypeScript configuration update for dynamic imports

3. **Re-export wrapper** (Current state)
   - Keep manual fetch implementation
   - Already mirrors generated client API contracts

### Phase 2: Generated Client Integration (When Ready)
**Estimated Effort:** 2-3 hours

**Steps:**
1. Create wrapper factory: `src/api/generated-client-factory.ts`
   ```typescript
   export function createGeneratedApiClient() {
     return new PizzaApiClient(baseUrl, networkAwareFetch);
   }
   ```

2. Update hooks to use generated client:
   ```typescript
   // src/api/hooks.ts
   async function fetchPizzas(): Promise<Pizza[]> {
     const client = await getGeneratedClient();
     const query = new GetAllPizzasQuery();
     const result = await client.search_for_pizzas(query);
     return result.result || [];
   }
   ```

3. Update all fetch calls to use generated methods:
   - `fetchPizzas()` ‚Üí `client.search_for_pizzas()`
   - `useCreateOrder()` ‚Üí `client.create_order()`
   - `useOrderById()` ‚Üí `client.get_order_status()`

4. Leverage generated error handling:
   - Remove manual error handling
   - Use generated `throwException` utilities

### Phase 3: Type Safety Improvements
**After Phase 2:**
- Replace all `as Pizza` type assertions with generated types
- Remove `any` type usages
- Full end-to-end type safety

## Benefits of Generated Client Integration

### Type Safety
- ‚úÖ Compile-time verification of API contracts
- ‚úÖ Automatic updates when backend API changes
- ‚úÖ IntelliSense support for all endpoints

### Maintainability
- ‚úÖ Single source of truth (OpenAPI spec)
- ‚úÖ No manual API endpoint maintenance
- ‚úÖ Automatic sync with backend changes

### Consistency
- ‚úÖ Standardized error handling
- ‚úÖ Consistent request/response wrapping
- ‚úÖ Unified retry and telemetry patterns

### Performance
- ‚úÖ Optimized generated code
- ‚úÖ Reduced manual boilerplate
- ‚úÖ Tree-shakeable exports

## Network-Aware Fetch Handler

Both current and generated implementations can use the same network-aware fetch:

```typescript
function createNetworkAwareFetch() {
  return {
    fetch: async (url: string | Request, init?: RequestInit) => {
      // Check network status
      if (!navigator.onLine) {
        throw new Error('Network is offline');
      }

      // Fetch with telemetry
      const response = await fetch(url, init);
      
      // Log success/failure
      if (!response.ok) {
        recordSpanEvent('api.request-error', { status: response.status });
      }

      return response;
    },
  };
}

// Use with generated client
const client = new PizzaApiClient(baseUrl, createNetworkAwareFetch());
```

## Regenerating the Client

To regenerate the client when the backend API changes:

```bash
npm run generate:client
# or with custom backend URL
npm run generate:client:dev http://localhost:5000
```

See `clients/generation/OPENAPI_GENERATION_GUIDE.md` for details.

## Testing Generated Client

```typescript
// Example test
const client = new PizzaApi.PizzaApiClient(
  'https://localhost:7160',
  mockFetch
);

const query = new GetAllPizzasQuery();
const result = await client.search_for_pizzas(query);

expect(result.result).toHaveLength(5);
```

## References

- **Generated File:** `clients/generated/react/src/api/generated.ts`
- **Generation Guide:** `clients/generation/OPENAPI_GENERATION_GUIDE.md`
- **Current Hooks:** `src/api/hooks.ts`
- **API Layer Documentation:** `docs/05-api-layer.md`

## Next Steps

1. ‚úÖ Document generated client structure *(completed)*
2. ‚è≥ Set up module resolution for generated client
3. ‚è≥ Create generated client wrapper with network awareness
4. ‚è≥ Migrate hooks to use generated client
5. ‚è≥ Update tests for generated client methods
6. ‚è≥ Deploy and monitor for issues

## Status

**Last Updated:** November 11, 2025  
**Generated Client Version:** NSwag 14.6.2.0  
**Integration Status:** Ready for Phase 2 (awaiting module resolution setup)
